// Generated by ScriptBuilder - 309 – Notification Service
// Feature: notifications | Role: service

// =========================================================
// 010 – Notification Service
// Feature: notifications
// Role: service
// Group: Services
// =========================================================
// FILE: src/services/notifications.js
// =========================================================



const admin = require('firebase-admin');
const { pool } = require('../db/pool');
const config = require('../config');

// Initialize Firebase Admin (if configured)
let firebaseInitialized = false;

const initFirebase = () => {
  if (!firebaseInitialized && config.firebase.projectId) {
    admin.initializeApp({
      projectId: config.firebase.projectId,
    });
    firebaseInitialized = true;
    console.log('[Firebase] Initialized');
  }
};

/**
 * Send push notification to a user
 */
const sendPushNotification = async (userId, title, body, data = {}) => {
  try {
    // Get user's FCM token
    const result = await pool.query(
      'SELECT fcm_token FROM users WHERE id = $1 AND fcm_token IS NOT NULL',
      [userId]
    );
    
    if (result.rows.length === 0 || !result.rows[0].fcm_token) {
      console.log(`[Notifications] No FCM token for user ${userId}`);
      return false;
    }
    
    const token = result.rows[0].fcm_token;
    
    // Send via Firebase (if initialized)
    if (firebaseInitialized) {
      await admin.messaging().send({
        token,
        notification: { title, body },
        data: Object.fromEntries(
          Object.entries(data).map(([k, v]) => [k, String(v)])
        ),
      });
    } else {
      console.log(`[Notifications] Would send to ${userId}: ${title} - ${body}`);
    }
    
    // Store notification in database
    await pool.query(
      `INSERT INTO notifications (user_id, type, title, body, data) 
       VALUES ($1, $2, $3, $4, $5)`,
      [userId, data.type || 'general', title, body, JSON.stringify(data)]
    );
    
    return true;
  } catch (error) {
    console.error('[Notifications] Error:', error);
    return false;
  }
};

/**
 * Notify drivers of new load in their area
 */
const notifyNearbyDrivers = async (load, driverIds) => {
  const title = `New Load Available`;
  const body = `${load.pickup_city}, ${load.pickup_state} → ${load.delivery_city}, ${load.delivery_state} • $${load.driver_payout}`;
  
  const promises = driverIds.map(driverId => 
    sendPushNotification(driverId, title, body, {
      type: 'new_load',
      loadId: load.id,
      pickupCity: load.pickup_city,
      deliveryCity: load.delivery_city,
    })
  );
  
  await Promise.allSettled(promises);
};

/**
 * Notify shipper of load status change
 */
const notifyLoadStatusChange = async (load, newStatus, driverName = '') => {
  const statusMessages = {
    accepted: `Your load has been accepted by ${driverName}`,
    en_route_pickup: `Driver is on the way to pickup`,
    picked_up: `Your freight has been picked up`,
    in_transit: `Your freight is in transit`,
    delivered: `Your freight has been delivered!`,
    cancelled: `Load has been cancelled`,
  };
  
  const body = statusMessages[newStatus] || `Load status: ${newStatus}`;
  
  await sendPushNotification(load.shipper_id, 'Load Update', body, {
    type: 'load_status',
    loadId: load.id,
    status: newStatus,
  });
};

module.exports = {
  initFirebase,
  sendPushNotification,
  notifyNearbyDrivers,
  notifyLoadStatusChange,
};
